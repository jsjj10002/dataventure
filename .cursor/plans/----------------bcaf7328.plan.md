<!-- bcaf7328-3c0f-4f65-b910-58e16b3735b1 fc55c0ef-80fd-486e-a26c-4092d71fd78e -->
# 인터뷰 평가 생성 오류 수정 계획

## 문제 분석

### 에러 로그

```
:8000/api/v1/evaluation/generate:1 Failed to load resource: 404 (Not Found)
:8080/api/v1/evaluation/7b1c7be1-e099-40b7-b29b-1a462faaf358:1 Failed to load resource: 404
```

### 원인 파악

**1. API 경로 불일치**

**service-ai (실제 엔드포인트)**:

- `/internal/ai/generate-evaluation` ✓ (존재함, evaluation.py:15)

**service-core (호출 시도)**:

- `/api/v1/evaluation/analyze` (라인 173에서 호출)

**프론트엔드 (호출 시도)**:

- `/api/v1/evaluation/generate` (test-chat/page.tsx:200)

**2. 데이터 흐름 문제**

현재 구조:

```
프론트엔드 → AI 서비스 (직접 호출) ❌
service-core → AI 서비스 (잘못된 경로) ❌
```

올바른 구조:

```
프론트엔드 → service-core → AI 서비스 → DB 저장
```

**3. 평가 조회 문제**

- 프론트엔드가 `interviewId`로 이동하지만 `evaluationId`로 조회 시도
- `/api/v1/evaluation/interview/:interviewId` 엔드포인트가 있지만 사용되지 않음

## 수정 계획

### 1. service-core: 평가 생성 트리거 엔드포인트 추가

**파일**: `service-core/src/routes/interview/index.ts`

**인터뷰 완료 API 수정** (라인 140-180):

```typescript
router.put('/:id/complete', authenticateToken, async (req, res) => {
  // 기존 인터뷰 완료 로직
  
  // AI 서비스에서 평가 생성
  try {
    // 1. 메시지 조회
    const messages = await prisma.interviewMessage.findMany({
      where: { interviewId: id },
      orderBy: { createdAt: 'asc' },
    });
    
    // 2. 프로필 조회
    const profile = await prisma.candidateProfile.findUnique({
      where: { userId: interview.candidateId },
    });
    
    // 3. AI 서비스 호출 (올바른 경로)
    const aiResponse = await axios.post(
      `${AI_SERVICE_URL}/internal/ai/generate-evaluation`,
      {
        conversationHistory: messages.map(m => ({
          role: m.role.toLowerCase(),
          content: m.content
        })),
        candidateProfile: profile,
        jobPosting: null
      }
    );
    
    // 4. 평가 결과를 DB에 저장
    const evaluation = await prisma.evaluation.create({
      data: {
        interviewId: id,
        ...aiResponse.data.scores,
        strengthsJson: JSON.stringify(aiResponse.data.feedback.strengths),
        weaknessesJson: JSON.stringify(aiResponse.data.feedback.weaknesses),
        detailedFeedback: aiResponse.data.feedback.overallFeedback,
        recommendedPositions: JSON.stringify(aiResponse.data.feedback.recommendedPositions)
      }
    });
  } catch (evalError) {
    console.error('평가 생성 오류:', evalError);
    // 에러가 나도 인터뷰 완료는 처리
  }
  
  res.json(updatedInterview);
});
```

### 2. 프론트엔드: 평가 요청 제거

**파일**: `app-web/src/app/interview/test-chat/page.tsx` (라인 198-205)

**수정 전**:

```typescript
// 평가 요청 (service-ai)
try {
  await apiClient.post(`${process.env.NEXT_PUBLIC_AI_SERVICE_URL || 'http://localhost:8000'}/api/v1/evaluation/generate`, {
    interviewId,
  });
} catch (evalError) {
  console.error('평가 생성 실패:', evalError);
}
```

**수정 후**:

```typescript
// 평가는 service-core에서 자동 생성됨 (제거)
```

### 3. 프론트엔드: 평가 조회를 interviewId 기반으로 변경

**파일**: `app-web/src/app/evaluation/[id]/page.tsx` (라인 44-48)

**현재**:

```typescript
const loadEvaluation = async () => {
  const response = await evaluationAPI.get(evaluationId);
  setEvaluation(response.data);
};
```

**수정 후**:

```typescript
const loadEvaluation = async () => {
  try {
    // interviewId로 평가 조회 시도
    const response = await evaluationAPI.getByInterview(evaluationId);
    setEvaluation(response.data);
  } catch (error: any) {
    // 404 에러 시 아직 평가가 생성되지 않음
    if (error.response?.status === 404) {
      toast.error('평가가 아직 생성되지 않았습니다. 잠시 후 다시 시도해주세요.');
      setTimeout(() => {
        router.push('/dashboard');
      }, 2000);
    } else {
      toast.error('평가 결과를 불러오는데 실패했습니다.');
    }
  }
};
```

### 4. service-ai: 응답 형식 확인 및 조정

**파일**: `service-ai/app/api/evaluation.py`

**확인 사항**:

- `EvaluationResponse` 모델이 service-core가 기대하는 형식과 일치하는지 확인
- scores에 필요한 모든 필드 포함:
                                - deliveryScore
                                - vocabularyScore
                                - comprehensionScore
                                - communicationAvg
                                - informationAnalysis
                                - problemSolving
                                - flexibleThinking
                                - negotiation
                                - itSkills
                                - overallScore

### 5. 에러 처리 개선

**service-core 인터뷰 완료 엔드포인트**:

```typescript
// 평가 생성 실패 시에도 인터뷰 완료는 처리
// 단, 알림이나 로그로 기록
if (evalError) {
  console.error('평가 생성 실패:', evalError);
  // 알림 생성 (평가 실패 안내)
  await prisma.notification.create({
    data: {
      userId: interview.candidateId,
      type: 'SYSTEM',
      title: '평가 생성 지연',
      message: '인터뷰 평가가 생성 중입니다. 잠시 후 확인해주세요.',
    }
  });
}
```

## 데이터 흐름

### 수정 후 플로우

```
1. 사용자: 인터뷰 완료
   ↓
2. 프론트엔드: PUT /api/v1/interview/:id/complete
   ↓
3. service-core: 
   - 인터뷰 상태 COMPLETED로 변경
   - 메시지 및 프로필 조회
   - POST /internal/ai/generate-evaluation (AI 서비스 호출)
   ↓
4. service-ai:
   - 대화 분석 및 평가 생성
   - 점수 및 피드백 반환
   ↓
5. service-core:
   - 평가 결과 DB 저장
   - 알림 생성
   ↓
6. 프론트엔드:
   - 2초 후 /evaluation/:interviewId로 이동
   - GET /api/v1/evaluation/interview/:interviewId
   ↓
7. 평가 결과 표시
```

## 구현 순서

1. **service-core 인터뷰 완료 로직 수정**

                                                - AI 서비스 호출 경로 수정
                                                - 평가 생성 및 저장 로직 추가

2. **프론트엔드 test-chat 수정**

                                                - 불필요한 평가 요청 제거

3. **프론트엔드 평가 페이지 수정**

                                                - interviewId로 조회하도록 변경
                                                - 404 에러 처리 개선

4. **service-ai 응답 형식 확인**

                                                - 필요 시 모델 수정

5. **테스트**

                                                - 인터뷰 전체 플로우 테스트
                                                - 평가 생성 및 조회 확인

## 참고: API 엔드포인트 정리

### service-ai

- `POST /internal/ai/generate-evaluation`: 평가 생성 (내부 호출용)

### service-core

- `PUT /api/v1/interview/:id/complete`: 인터뷰 완료 (평가 자동 생성)
- `GET /api/v1/evaluation/:id`: 평가 ID로 조회
- `GET /api/v1/evaluation/interview/:interviewId`: 인터뷰 ID로 평가 조회

### 프론트엔드

- 인터뷰 완료: `PUT /api/v1/interview/:id/complete`
- 평가 조회: `GET /api/v1/evaluation/interview/:interviewId`

### To-dos

- [ ] 회원가입 페이지에 비밀번호 대문자/소문자 검증 추가
- [ ] 프로필 저장 후 대시보드로 자동 이동 기능 추가 (구직자/채용담당자)
- [ ] 프로필 사진 표시 오류 수정 (URL 전체 경로 생성 및 에러 처리)
- [ ] 대시보드 프로필 완성도 계산 개선 및 색상 로직 추가 (노란-초록-파란)
- [ ] 인터뷰 준비 페이지에 개발 테스트 버튼 추가
- [ ] 텍스트-텍스트 인터뷰 테스트 페이지 생성 (채팅 인터페이스)
- [ ] 텍스트 인터뷰 페이지와 백엔드 API 연동